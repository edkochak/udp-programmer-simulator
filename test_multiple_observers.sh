#!/bin/bash

# Скрипт для демонстрации множественных наблюдателей (8 баллов)

echo "=================================================="
echo "  ТЕСТИРОВАНИЕ МНОЖЕСТВЕННЫХ НАБЛЮДАТЕЛЕЙ"
echo "=================================================="
echo "Этот скрипт демонстрирует возможность подключения"
echo "нескольких наблюдателей одновременно"
echo "=================================================="
echo

# Проверяем, работает ли сервер
if ! pgrep -f "build/server" > /dev/null; then
    echo "Сервер не запущен. Запускаем сервер и программистов..."
    ./build/server 127.0.0.1 8080 &
    sleep 2
    ./build/programmer "Тест_Программист1" 127.0.0.1 8080 8081 &
    ./build/programmer "Тест_Программист2" 127.0.0.1 8080 8082 &
    sleep 2
fi

echo "Запуск множественных наблюдателей..."
echo "Каждый наблюдатель работает независимо"
echo

# Запускаем несколько наблюдателей в разных терминалах
for i in 1 2 3; do
    PORT=$((8090 + i))
    echo "Запуск наблюдателя #$i на порту $PORT"
    
    if command -v gnome-terminal > /dev/null; then
        gnome-terminal -- bash -c "./build/observer 127.0.0.1 8080 $PORT; read -p 'Нажмите Enter для закрытия...'"
    elif command -v konsole > /dev/null; then
        konsole -e bash -c "./build/observer 127.0.0.1 8080 $PORT; read -p 'Нажмите Enter для закрытия...'"
    elif command -v xterm > /dev/null; then
        xterm -e bash -c "./build/observer 127.0.0.1 8080 $PORT; read -p 'Нажмите Enter для закрытия...'" &
    else
        echo "Запуск наблюдателя #$i в фоне (используйте 'fg' для переключения)"
        ./build/observer 127.0.0.1 8080 $PORT &
    fi
    
    sleep 1
done

echo
echo "Наблюдатели запущены. Каждый из них независимо отображает"
echo "состояние системы и может быть отключен/подключен в любой момент."
echo
echo "Для завершения нажмите Ctrl+C"

# Ожидаем сигнал завершения
trap "echo 'Завершение тестирования...'; exit 0" SIGINT SIGTERM

# Показываем статус каждые 10 секунд
while true; do
    sleep 10
    echo "Система продолжает работать... ($(date))"
done
